@{
    ViewBag.Title = "Transactions";
}

<h2>Transactions</h2>

<div class="table-responsive card">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Date</th>
                <th>Merchant</th>
                <th>Category</th>
                <th>Amount</th>
            </tr>
        </thead>
        <tbody id="txn-body">
            <tr>
                <td colspan="4" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<nav>
    <ul class="pagination justify-content-center" id="txn-pagination"></ul>
</nav>

<script>
$(function () {
    const pageSize = 5;  
    let currentPage = 1;
    let transactions = [];

    function renderTable(page) {
        const start = (page - 1) * pageSize;
        const end = start + pageSize;
        const pageData = transactions.slice(start, end);

        let rows = "";
        if (pageData.length > 0) {
            pageData.forEach(t => {
                rows += `
                    <tr>
                        <td>${new Date(t.Date).toLocaleDateString()}</td>
                        <td>${t.Merchant}</td>
                        <td>${t.Category}</td>
                        <td>${t.Amount.toFixed(2)}</td>
                    </tr>`;
            });
        } else {
            rows = `<tr><td colspan="4" class="text-center">No transactions found.</td></tr>`;
        }

        $("#txn-body").html(rows);
        renderPagination();
    }

    function renderPagination() {
        const totalPages = Math.ceil(transactions.length / pageSize);
        let html = "";

        for (let i = 1; i <= totalPages; i++) {
            html += `<li class="page-item ${i === currentPage ? "active" : ""}">
                        <a class="page-link" href="#">${i}</a>
                    </li>`;
        }

        $("#txn-pagination").html(html);
    }
 
    $("#txn-pagination").on("click", "a", function (e) {
        e.preventDefault();
        const selectedPage = parseInt($(this).text());
        if (selectedPage !== currentPage) {
            currentPage = selectedPage;
            renderTable(currentPage);
        }
    });
     
    $.get('@Url.Action("GetTransactions", "Transactions")', function (data) {
        if (typeof data === "string") data = JSON.parse(data);

        transactions = data.transactions || [];
        renderTable(currentPage);
    })
    .fail(function () {
        $("#txn-body").html("<tr><td colspan='4' class='text-center text-danger'>Failed to load transactions.</td></tr>");
    });
});
</script>
